-- GENERATED CODE
-- Node Box Editor, version 0.7 - Iron
-- Namespace: test

local node_box = {
		type = "fixed",
		fixed = {
			{-0.1875, -0.5, 0.375, 0.1875, 0.5, 0.5}, -- NodeBox3
			{-0.25, -0.5, 0.3125, -0.1875, 0.5, 0.5}, -- NodeBox4
			{-0.3125, -0.5, 0.25, -0.25, 0.5, 0.5}, -- NodeBox5
			{-0.375, -0.5, 0.1875, -0.3125, 0.5, 0.5}, -- NodeBox6
			{-0.5, -0.5, -0.5, -0.375, 0.5, 0.5}, -- NodeBox7
			{-0.375, -0.5, -0.5, -0.3125, 0.5, -0.1875}, -- NodeBox8
			{-0.3125, -0.5, -0.5, -0.25, 0.5, -0.25}, -- NodeBox9
			{-0.25, -0.5, -0.5, -0.1875, 0.5, -0.3125}, -- NodeBox10
			{-0.1875, -0.5, -0.5, 0.1875, 0.5, -0.375}, -- NodeBox11
			{0.1875, -0.5, -0.5, 0.25, 0.5, -0.3125}, -- NodeBox12
			{0.25, -0.5, -0.5, 0.3125, 0.5, -0.25}, -- NodeBox13
			{0.3125, -0.5, -0.5, 0.375, 0.5, -0.1875}, -- NodeBox14
			{0.375, -0.5, -0.5, 0.5, 0.5, 0.5}, -- NodeBox15
			{0.3125, -0.5, 0.1875, 0.375, 0.5, 0.5}, -- NodeBox16
			{0.25, -0.5, 0.25, 0.3125, 0.5, 0.5}, -- NodeBox17
			{0.1875, -0.5, 0.3125, 0.25, 0.5, 0.5}, -- NodeBox18
			{-0.1875, -0.5, 0.3125, 0.1875, 0.375, 0.375}, -- NodeBox19
			{-0.25, -0.5, 0.25, -0.125, 0.375, 0.3125}, -- NodeBox20
			{-0.3125, -0.5, 0.125, -0.25, 0.375, 0.25}, -- NodeBox21
			{-0.375, -0.5, -0.1875, -0.3125, 0.375, 0.1875}, -- NodeBox22
			{-0.3125, -0.5, -0.25, -0.25, 0.375, -0.125}, -- NodeBox23
			{-0.25, -0.5, -0.3125, -0.125, 0.375, -0.25}, -- NodeBox24
			{-0.1875, -0.5, -0.375, 0.1875, 0.375, -0.3125}, -- NodeBox25
			{0.125, -0.5, -0.3125, 0.25, 0.375, -0.25}, -- NodeBox26
			{0.25, -0.5, -0.25, 0.3125, 0.375, -0.125}, -- NodeBox27
			{0.3125, -0.5, -0.1875, 0.375, 0.375, 0.1875}, -- NodeBox28
			{0.25, -0.5, 0.125, 0.3125, 0.375, 0.25}, -- NodeBox29
			{0.125, -0.5, 0.25, 0.25, 0.375, 0.3125}, -- NodeBox30
			{-0.125, -0.5, 0.25, 0.125, 0.25, 0.3125}, -- NodeBox31
			{-0.25, -0.5, 0.1875, -0.125, 0.25, 0.25}, -- NodeBox32
			{-0.25, -0.5, 0.125, -0.1875, 0.25, 0.1875}, -- NodeBox33
			{-0.3125, -0.5, -0.125, -0.25, 0.25, 0.125}, -- NodeBox34
			{-0.25, -0.5, -0.1875, -0.1875, 0.25, -0.125}, -- NodeBox35
			{-0.25, -0.5, -0.25, -0.125, 0.25, -0.1875}, -- NodeBox36
			{-0.125, -0.5, -0.3125, 0.125, 0.25, -0.25}, -- NodeBox37
			{0.125, -0.5, -0.25, 0.1875, 0.25, -0.1875}, -- NodeBox38
			{0.1875, -0.5, -0.25, 0.25, 0.25, -0.125}, -- NodeBox39
			{0.25, -0.5, -0.125, 0.3125, 0.25, 0.125}, -- NodeBox40
			{0.1875, -0.5, 0.125, 0.25, 0.25, 0.1875}, -- NodeBox41
			{0.125, -0.5, 0.1875, 0.25, 0.25, 0.25}, -- NodeBox42
			{-0.125, -0.5, 0.1875, 0.125, 0.125, 0.25}, -- NodeBox43
			{-0.1875, -0.5, 0.125, -0.125, 0.125, 0.1875}, -- NodeBox44
			{-0.25, -0.5, -0.125, -0.1875, 0.125, 0.125}, -- NodeBox45
			{-0.1875, -0.5, -0.1875, -0.125, 0.125, -0.125}, -- NodeBox46
			{-0.125, -0.5, -0.25, 0.125, 0.125, -0.1875}, -- NodeBox47
			{0.125, -0.5, -0.1875, 0.1875, 0.125, -0.125}, -- NodeBox48
			{0.1875, -0.5, -0.125, 0.25, 0.125, 0.125}, -- NodeBox49
			{0.125, -0.5, 0.125, 0.1875, 0.125, 0.1875}, -- NodeBox50
			{-0.125, -0.5, 0.125, 0.125, 0, 0.1875}, -- NodeBox51
			{-0.125, -0.5, 0.0625, -0.0625, 0, 0.125}, -- NodeBox52
			{-0.1875, -0.5, -0.125, -0.125, 0, 0.125}, -- NodeBox53
			{-0.125, -0.5, -0.125, -0.0625, 0, -0.0625}, -- NodeBox54
			{-0.125, -0.5, -0.1875, 0.125, 0, -0.125}, -- NodeBox55
			{0.0625, -0.5, -0.125, 0.125, 0, -0.0625}, -- NodeBox56
			{0.125, -0.5, -0.125, 0.1875, 0, 0.125}, -- NodeBox57
			{0.0625, -0.5, 0.0625, 0.125, 0, 0.125}, -- NodeBox58
			{-0.0625, -0.5, 0.0625, 0.0625, -0.125, 0.125}, -- NodeBox59
			{-0.125, -0.5, -0.0625, -0.0625, -0.125, 0.0625}, -- NodeBox60
			{-0.0625, -0.5, -0.125, 0.0625, -0.125, -0.0625}, -- NodeBox61
			{0.0625, -0.5, -0.0625, 0.125, -0.125, 0.0625}, -- NodeBox62
			{-0.0625, -0.5, -0.0625, 0.0625, -0.25, 0.0625}, -- NodeBox63
		}
	}


local vortex_node_box =  {
		type = "fixed",
		fixed = {
			{0.4375, -0.5, -0.125, 0.5, 0.5, 0.125}, -- NodeBox1
			{0.375, -0.5, 0.125, 0.4375, 0.5, 0.25}, -- NodeBox2
			{0.3125, -0.5, 0.25, 0.375, 0.5, 0.3125}, -- NodeBox3
			{0.25, -0.5, 0.25, 0.3125, 0.5, 0.375}, -- NodeBox4
			{0.125, -0.5, 0.375, 0.25, 0.5, 0.4375}, -- NodeBox5
			{-0.125, -0.5, 0.4375, 0.125, 0.5, 0.5}, -- NodeBox6
			{-0.25, -0.5, 0.375, -0.125, 0.5, 0.4375}, -- NodeBox7
			{-0.3125, -0.5, 0.25, -0.25, 0.5, 0.375}, -- NodeBox8
			{-0.375, -0.5, 0.25, -0.3125, 0.5, 0.3125}, -- NodeBox9
			{-0.4375, -0.5, 0.125, -0.375, 0.5, 0.25}, -- NodeBox10
			{-0.5, -0.5, -0.125, -0.4375, 0.5, 0.125}, -- NodeBox11
			{-0.125, -0.5, -0.5, 0.125, 0.5, -0.4375}, -- NodeBox12
			{-0.25, -0.5, -0.4375, -0.125, 0.5, -0.375}, -- NodeBox13
			{-0.4375, -0.5, -0.25, -0.375, 0.5, -0.125}, -- NodeBox14
			{-0.375, -0.5, -0.3125, -0.25, 0.5, -0.25}, -- NodeBox15
			{-0.3125, -0.5, -0.375, -0.25, 0.5, -0.3125}, -- NodeBox18
			{0.125, -0.5, -0.4375, 0.25, 0.5, -0.375}, -- NodeBox19
			{0.375, -0.5, -0.25, 0.4375, 0.5, -0.125}, -- NodeBox20
			{0.25, -0.5, -0.375, 0.375, 0.5, -0.3125}, -- NodeBox21
			{0.3125, -0.5, -0.3125, 0.375, 0.5, -0.25}, -- NodeBox22
		}
	}

local sand_portal_params=  {
 fuel_stack = "default:sand 1",
 --fuel_surrounding = "default:sand",
 --fuel_surrounding_count = 4,
 portal_type = element_portals.IN_PORTAL,
 portal_groups = {"sand_portals"},
 filter_group = "sand_portals",
 active_node = "sand_portals:sand_portal_active", 
 inactive_node = "sand_portals:sand_portal",
 swap_enabled = true,
 replace_surroundings = {
 	except_nodes_containing_in_name = {"water_source", "lava_source", "lava_flowing", "water_flowing", "sand_portal_vortex" },
 	offsets = {
 		{pos = {y = 1}, replacement_node_name="sand_portals:sand_portal_vortex"},
 		{pos = {y = 2}, replacement_node_name="sand_portals:sand_portal_vortex"}
 	}
 }
}

element_portals:register_private_portal_node("sand_portals:sand_portal_active", {
	description = "Sand Portal - Input",
	tiles = {{name="sand_portal_anim.png", animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=1.0}}, "default_sand.png^default_glass.png", "default_sand.png^default_glass.png", "default_sand.png^default_glass.png","default_sand.png^default_glass.png", "default_sand.png^default_glass.png"},
	is_ground_content = true,
	drawtype = "nodebox",
	node_box = node_box,
	paramtype="light",
	groups = {cracky=3}
}, sand_portal_params)

element_portals:register_private_portal_node("sand_portals:sand_portal", {
	description = "Sand Portal - Input",
	tiles = {"default_sand.png^portal_glass.png",  "default_sand.png^default_glass.png", "default_sand.png^default_glass.png", "default_sand.png^default_glass.png","default_sand.png^default_glass.png", "default_sand.png^default_glass.png"},

	is_ground_content = true,
	drawtype = "nodebox",
	node_box = node_box,
	paramtype="light",
	groups = {cracky=3}
}, sand_portal_params)

element_portals:register_portal_abm(sand_portal_params)

local teleport_to = function(selected_portal_name, player, meta)
	element_portals:teleport_to(selected_portal_name, player, false, meta)
end

local player_in_radius = function (pos, player_name) 
	local all_objects = minetest.get_objects_inside_radius(pos, element_portals.AUTO_TELEPORT_SCAN_RADIUS or 2)
	local players = {}
	local _,obj
	local result = false
	for _,obj in ipairs(all_objects) do
		if obj:is_player() and obj:get_player_name() == player_name then		
			result = obj
			break
		end
	end
	return result
end

minetest.register_abm({
		nodenames = {"sand_portals:sand_portal_active"} ,
		interval = 0.5,
		chance = 1,
		action = function(pos, node, active_object_count, active_object_count_wider)
			local meta = minetest.get_meta(pos)
			local owner = meta:get_string("owner")
			local selected_portal_name = meta:get_string("selected_portal_name")
			if not owner and not selected_portal_name then 
				return
			end
			local player = player_in_radius(pos, owner)
			if player then 
				teleport_to(selected_portal_name, player, meta)
			end 
		end
})

local desert_sand_portal_params =  {
 portal_type = element_portals.OUT_PORTAL,
 portal_groups = {"sand_portals"},
 active_node = "sand_portals:desert_sand_portal"
}

element_portals:register_private_portal_node("sand_portals:desert_sand_portal", {
	description = "Desert Sand Portal - Output",
	tiles = {"default_desert_sand.png^portal_glass.png",  "default_desert_sand.png^default_glass.png", "default_desert_sand.png^default_glass.png", "default_desert_sand.png^default_glass.png","default_desert_sand.png^default_glass.png", "default_desert_sand.png^default_glass.png"},
	is_ground_content = true,
	drawtype = "nodebox",
	node_box = node_box,
	paramtype="light",
	groups = {cracky=3}
}, desert_sand_portal_params)


minetest.register_node("sand_portals:quick_sand", {
	description = "Quick Sand",
	tiles = {{name="quick_sand_top_anim.png", animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=1.0}},"quick_sand_bottom.png", "quick_sand_side.png", "quick_sand_side.png","quick_sand_side.png", "quick_sand_side.png"},
	is_ground_content = true,
	use_texture_alpha = true,
	liquidtype =  "source",
	liquid_alternative_flowing = "sand_portals:quick_sand_field",
	liquid_alternative_source  = "sand_portals:quick_sand",
	walkable = false,
	drop = "default:sand",
	pointable = true,
	diggable = true,
	buildable_to = true,
	liquid_renewable = false,
	paramtype = "light",
	
	liquid_viscosity = LAVA_VISC-3 ,
	groups = {water=3, liquid=3, crumbly=3, sand=1}
})

minetest.register_node("sand_portals:quick_sand_field", {
	description = "Quick Sand Field",
	tiles = {"default_sand.png"},
	drawtype = "airlike",
	is_ground_content = true,
	liquidtype =  "none",
	liquid_alternative_flowing = "sand_portals:quick_sand_field",
	liquid_alternative_source  = "sand_portals:quick_sand",
	walkable = false,
	pointable = false,
	diggable = false,
	buildable_to = true,
	paramtype = "light",
	liquid_viscosity = 30 ,
	groups = {water=3, liquid=3}
})


minetest.register_node("sand_portals:sand_portal_vortex", {
	description = "Sand Portal - Vortex",
	--tiles = {{name="vortex_anim.png", animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=0.5}}},
	tiles = {"vortex_right.png","vortex_left.png", "vortex_right.png", "vortex_left.png","vortex_right.png", "vortex_left.png"},
	drawtype = "nodebox",
	is_ground_content = true,
	use_texture_alpha = true,
	liquidtype =  "source",
	light_source = LIGHT_MAX - 1,
	node_box = vortex_node_box,
	liquid_alternative_flowing = "sand_portals:sand_portal_vortex_power_field",
	liquid_alternative_source  = "sand_portals:sand_portal_vortex",
	walkable = false,
	pointable = false,
	diggable = false,
	buildable_to = true,
	paramtype = "light",
	liquid_viscosity = LAVA_VISC,
	groups = {water=3, liquid=3}
})

minetest.register_node("sand_portals:sand_portal_vortex_power_field", {
	description = "Sand Portal - Vortex Field",
	tiles = {"default_sand.png"},
	drawtype = "airlike",
	is_ground_content = true,
	liquidtype =  "none",
	liquid_alternative_flowing = "sand_portals:sand_portal_vortex_power_field",
	liquid_alternative_source  = "sand_portals:sand_portal_vortex",
	walkable = false,
	pointable = false,
	diggable = false,
	buildable_to = true,
	paramtype = "light",
	liquid_viscosity = 30 ,
	groups = {water=3, liquid=3}
})


minetest.register_abm({
		nodenames = {"sand_portals:sand_portal_vortex"} ,
		interval = 3,
		chance = 1,
		action = function(pos, node, active_object_count, active_object_count_wider)
			local result = element_portals:node_on_axis(pos, "sand_portal_active", -4, -1, "y")
			if result.count == 0 then 	
				minetest.set_node(pos, {name="air"})
			end			 
		end
	})
	
minetest.register_craft({
	output = 'sand_portals:sand_portal',
	recipe = {
		{'default:glass', 'sand_portals:quick_sand', 'default:glass'},
		{'default:glass', 'default:mese_crystal', 'default:glass'},
		{'default:glass', 'default:glass', 'default:glass'}
	}
})

minetest.register_craft({
	output = 'sand_portals:desert_sand_portal',
	recipe = {
		{'default:glass', 'default:desert_sand', 'default:glass'},
		{'default:glass', 'default:mese_crystal', 'default:glass'},
		{'default:glass', 'default:glass', 'default:glass'}
	}
})

minetest.register_craft({
	output = 'sand_portals:quick_sand',
	recipe = {
		{'', 'default:sand', ''},
		{'', 'bucket:bucket_water', ''},
		{'', '', ''}
	}
})

